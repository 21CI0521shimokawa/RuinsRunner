using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using DG.Tweening;

public class EnemyController : ObjectSuperClass
{
    private StateMachine EnemyState; //それぞれのステート(class)の管理
    private const float signPrefubDestroyTime = 3.0f; //攻撃予兆オブジェクトの破棄時間
    private Tween EnemyTweener;
    public Tween _EnemyTweener
    {
        get { return EnemyTweener; }
        set { EnemyTweener = value; }
    }
    [Header("Enemyアニメーター取得")]
    [SerializeField, Tooltip("アニメーター")] Animator EnemyAnimator;
    public Animator _EnemyAnimator
    {
        get { return EnemyAnimator; }
    }
    [Header("EnemyAttackステート関連")]
    [SerializeField, Tooltip("攻撃予兆オブジェクト")] GameObject AttackSignsPrefubs;
    public GameObject _AttackSignsPrefubs
    {
        get { return AttackSignsPrefubs; } 
    }
    [SerializeField, Tooltip("攻撃する時のSE")] AudioClip AttackSE;
    public AudioClip _AttackSE
    {
        get { return AttackSE; }
    }

    /// <summary>
    /// ゲームが始まる時に一度だけ呼ばれる関数
    /// </summary>
    void Start()
    {
        //AttackFromBackが始まるまではステートをRunにする
        EnemyState = new StateMachine(new EnemyStateRun()); 
    }

    /// <summary>
    /// 存在する限り毎フレーム呼び出される関数
    /// </summary>
    void Update()
    {
        //現在のステートを毎フレーム呼び出す
        EnemyState.Update(this.gameObject);
    }

    /// <summary>
    /// 当たり判定の処理関数
    /// </summary>
    /// <param name="other"> 衝突判定</param>
    protected void OnTriggerEnter(Collider Other)
    {
        // EnemyAttackがついているオブジェクトに衝突したらステートをAttackFromBackに変更
        if (Other.CompareTag("EnemyAttack"))
        { 
            EnemyState = new StateMachine(new EnemyStateAttackFromBack());
        }
    }
    /// <summary>
    /// リソースを解放
    /// </summary>
    /// <param name="_disposing">リソースを解放したかの判定</param>
    protected override void Dispose(bool Disposing)
    {
        if (this.isDisposed_)
        {
            // 解放済みなので処理しない
            return;
        }
        // Dispose済みを記録
        this.isDisposed_ = true;

        // ★★★忘れずに、基底クラスの Dispose を呼び出す【重要】
        base.Dispose(Disposing);
    }

    /// <summary>
    /// 攻撃予兆の生成
    /// </summary>
    /// <param name="SignPrefub">攻撃予兆オブジェクト</param>
    /// <param name="EnemyTransform">Enemyの位置取得</param>
    public void CreateSignPrefub(GameObject SignPrefub, Transform EnemyTransform)
    {
        //攻撃予兆オブジェクトを生成する位置設定
        var InstansPositon = new Vector3(EnemyTransform.position.x, EnemyTransform.position.y + 0.1f, EnemyTransform.position.z + 6);
        //攻撃予兆オブジェクト生成
        GameObject instanceObject = Instantiate(SignPrefub, InstansPositon, EnemyTransform.rotation);
        DOVirtual.DelayedCall(signPrefubDestroyTime, () =>
        {
            //オブジェクト破棄
            Destroy(instanceObject);
        });
    }
}
